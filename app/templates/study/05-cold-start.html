{% from 'util/navbar.html' import navbar %}
<!DOCTYPE html>
<html lang="en">
    {% include 'util/head.html' %}
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
<body>

    {{ navbar('background', next) }}

    <h3>Are you interested in or did you enjoy watching this movie</h3>

    <div class="container" id="container"></div>

    <div class="tinder-buttons">
        <button id="reject">&#x2715;</button>
        <button id="accept">&#x2713;</button>
    </div>

    <script type="text/javascript">
        const MOVIES_SSKEY = 'movies';
        const CONTINUE_THRESHOLD = {{ threshold or 10 }};
        const POST_MOVIES_URL = `{{ url_for('post_movie_preferences_for_user', uid = uid, system = system or 'none') }}`;
        const GET_NEW_MOVIES_URL = `{{ get_movies_url }}`;
        const SYSTEM = `{{ system or 'none' }}`;

        const container = document.getElementById('container');
        const movies = JSON.parse(sessionStorage.getItem(MOVIES_SSKEY) || '{ }');

        function refresh () {
            if (container.classList.contains('loading')) {
                return;
            }

            const hits = Object.keys(movies).map((key) => movies[key]).filter((a) => a).length;
            if (hits >= CONTINUE_THRESHOLD) {
                // When we have n positive hits, continue
                sessionStorage.setItem(MOVIES_SSKEY, JSON.stringify(movies));

                // Send data to API
                fetch(POST_MOVIES_URL, {
                    method: 'POST',
                    body: JSON.stringify(movies),
                    headers: { 'Content-Type': 'application/json' },
                })
                    .then(() => {
                        sessionStorage.setItem(MOVIES_SSKEY, '{ }');
                        location = `{{ url_for(next) }}`
                    })
                    .catch((err) => console.error(err));
            } else {
                container.innerHTML = '';
                container.classList.add('loading');
                fetch(GET_NEW_MOVIES_URL, { method: 'GET' })
                    .then((res) => res.json())
                    .then(({ id, title, image }) => {
                        container.innerHTML = '';
                        const label = document.createElement('label');
                        const img = document.createElement('img');
                        const span = document.createElement('span');
                        label.classList.add('movie-card');
                        container.id = id;
                        img.src = image;
                        span.appendChild(document.createTextNode(title));
                        label.appendChild(img);
                        label.appendChild(span);
                        container.appendChild(label);
                        container.classList.remove('loading');
                    })
                    .catch((err) => {
                        container.classList.remove('loading');
                        container.innerText = 'Failed to load. Please ask the supervisor for help.'
                        console.error(err);
                    });
            }
        }

        function accept () {
            const id = container.id;
            movies[id] = true;
            refresh();
        }

        function reject () {
            const id = container.id;
            movies[id] = true;
            refresh();
        }

        document.querySelector('.tinder-buttons button:first-child').addEventListener('click', reject);
        document.querySelector('.tinder-buttons button:last-child').addEventListener('click', accept);
        window.addEventListener('keypress', (e) => e.keyCode === 101 ? reject() : null);
        window.addEventListener('keypress', (e) => e.keyCode === 105 ? accept() : null);
        const hammerJS = new Hammer(document.body);
        hammerJS.on('swiperight', accept);
        hammerJS.on('swipeleft', reject);

        refresh();
    </script>
</body>
</html>
